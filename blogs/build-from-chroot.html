<!--
    Anurag Roy's portfolio website
    Copyright (C) 2020-2022 Anurag Roy

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="subject" content="The one thing most tutorials for building Arch Linux packages miss | Anurag Roy">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/media-query.css">
    <link rel="stylesheet" href="../css/themes.css">

    <!-- Miscellaneous -->
    <link rel="author" href="https://royarg02.github.io">
    <link rel="me" href="mailto:anuragr9847@gmail.com">
    <meta name="copyright" content="Anurag Roy">
    <link rel="license" href="https://creativecommons.org/licenses/by-nd/4.0">

    <title>The one thing most tutorials for building Arch Linux packages miss | Anurag Roy</title>
  </head>
  <body>
    <header id="header">
      <h1 id="header-title"><a href="../index.html#intro">Anurag Roy</a></h1>
      <nav id="header-link">
        <a href="../index.html#blogs" title="Blogs I've written">Blogs</a
        ><a href="../index.html#talks" title="Talks I've given">Talks</a
        ><a href="../index.html#contributions" title="My contributions">Contributions</a
        ><a href="../index.html#projects" title="Projects I've worked on">Projects</a>
      </nav>
    </header>
    <main>
      <article>
        <h2 class="heading">The one thing most tutorials for building Arch Linux packages miss</h2>
        <p class="para">28 May 2022</p>
        <p class="para">
          I've recently begun <a href="./packages.html">packaging my custom builds of known software</a>
          I use on my Linux setup.
        </p>
        <p class="para">
          Creating packages for Arch-based distros requires a description file called
          <a href="https://wiki.archlinux.org/title/PKGBUILD" target="_blank">PKGBUILD</a>,
          which lists several metadata. Two of the important ones are <code>depends</code> and <code>makedepends</code>.
        </p>
        <ul>
          <li>
            <strong><code>depends</code></strong>: Packages or libraries the package depends on to <em>run</em>.
            In other words, the runtime dependencies.
          </li>
          <li>
            <strong><code>makedepends</code></strong>: Packages or libraries the package depends on to <em>build</em>.
            In other words, the compile-time dependencies.
          </li>
        </ul>
        <p class="para">
          These two are often overlooked in part by PKGBUILD writers. Because, "hey, it built and ran fine on <em>my</em> machine!"
        </p>
        <p class="para">
          Don't do that.
        </p>
        <p class="para">
          The dependencies might be already present on your system, either explicitly installed or brought in as a dependency
          by another package. As such, you wouldn't know what exactly will be required by other setups.
        </p>
        <p class="para">
          A way to determine the dependencies would be to test the PKGBUILDs on a fresh install. But using a separate system with only
          <code>base</code> packages and then adding the dependencies one at a time can be a pain.
        </p>
        <p class="para">
          An alternative is to make them in <a href="https://wiki.archlinux.org/title/Chroot" target="_blank">chroot</a>.
          Think of it as containerised Arch Linux system with no access to the files(including packages) on your host system. The
          <a href="https://wiki.archlinux.org/title/DeveloperWiki:Building_in_a_clean_chroot" target="_blank">ArchWiki has a guide on this</a>,
          so go over there for the tutorial. Let me show you what it would look like in practice.
        </p>
        <p class="para">
          Take the example of the <a href="https://github.com/RoyARG02/slock-royarg-git" target="_blank">slock-royarg-git</a> package.
          Below are its
          <a href="https://github.com/RoyARG02/slock-royarg-git/blob/8c22c966396c0d3f756890c149a777bc50a65802/PKGBUILD#L10-L11">dependencies</a>:
        </p>
        <pre>
depends=('libxcrypt' 'libxrandr' 'libxinerama' 'libxft')
makedepends=('git')</pre>
        <p class="para">
          If we remove all dependencies(except <code>git</code>, as that is required to fetch the source in the first place), and try to
          build, we will hit an error:
        </p>
        <pre>
slock.c:20:10: fatal error: X11/extensions/Xrandr.h: No such file or directory
20 | #include &#60;X11/extensions/Xrandr.h&#62;
   |          ^~~~~~~~~~~~~~~~~~~~~~~~~
compilation terminated.
make: *** [Makefile:19: slock.o] Error 1</pre>
        <p class="para">
          So we can figure out the compile-time dependencies, but what about the runtime dependencies? We run:
        </p>
        <pre>makechrootpkg -c <strong>-n</strong> -r $CHROOT</pre>
        <p class="para">
          The <strong><code>-n</code></strong> flag additionally runs
          <a href="https://wiki.archlinux.org/title/Namcap" target="_blank"><code>namcap</code></a>, which checks for packaging issues.
          If we miss a runtime dependency, <code>namcap</code> will produce the following messages:
        </p>
        <pre>
slock-royarg-git E: Dependency libxft detected and not included (libraries ['usr/lib/libXft.so.2'] needed in files ['usr/bin/slock'])
slock-royarg-git E: Dependency libxcrypt detected and not included (libraries ['usr/lib/libcrypt.so.2'] needed in files ['usr/bin/slock'])
slock-royarg-git E: Dependency libxrandr detected and not included (libraries ['usr/lib/libXrandr.so.2'] needed in files ['usr/bin/slock'])
slock-royarg-git E: Dependency libxinerama detected and not included (libraries ['usr/lib/libXinerama.so.1'] needed in files ['usr/bin/slock'])</pre>
        <p class="para">
          So you've now figured out the package dependencies and made sure that it will build and run as expected on other systems.
        </p>
        <hr>
      </article>
    </main>
      <footer>
        <div id="footer-start">
          <div id="license-blog">This work is licensed under
            <a href="https://creativecommons.org/licenses/by-nd/4.0" target="_blank">CC&nbsp;BY&#8209;ND&nbsp;4.0</a>.
          </div>
          <div id="license-code">Source code is licensed under
            <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank">GNU&nbsp;GPL&nbsp;3.0</a>.
          </div>
        </div>
        <div id="footer-end">
          <div id="copyright">Copyright &copy; Anurag Roy 2020-2022.</div>
          <div id="powered-by">
            Powered by good ol' HTML5, CSS3 and
            <a href="https://pages.github.com"> Github&nbsp;Pages</a>.
          </div>
        </div>
      </footer>
  </body>
</html>
